<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../json-select/json-select.html">

<!--
`<laterooms-rate check-in="{{checkIn}}" nights="{{nights}}" ></laterooms-rate>` list laterooms rate for time in a hotel
@demo demo.html
-->
<dom-module id="laterooms-rate">
  <template>
    <iron-ajax auto url="{{_url}}" last-response="{{data}}"></iron-ajax>
    <json-select json="{{data}}" select=".room .numeric_price" output="{{rates}}"></json-select>
    <div class="layout center">
      <div class="layout horizontal">
        <paper-material class="layout middle" style="max-width: 300px;">
          <div style="margin:40px;text-align:center;padding: 20px">
            Laterooms Rate From
            <p>{{rate}}</p>
          </div>
        </paper-material>
      </div>
    </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: "laterooms-rate",
    properties: {
      day: {computed: 'getDay(checkIn)'},
      month: {computed: 'getMonth(checkIn)'},
      year: {computed: 'getYear(checkIn)'},
      nights: {type: Number, value: 1},
      url: {value:'http://www.laterooms.com/en/p'},
      hotelId: {value: 69407},
      affiliateid: {value: 3095},
      _url: {computed: 'getUrl(day, month, year, nights, hotelId, affiliateid, server)'},
      link: {computed: 'getLink(url, day, month, year, nights, hotelId, affiliateid)', notify: true},
      rate: {computed: 'getRate(rates)'},
      server:{value: "/bower_components/laterooms-rate/server/"}
    },
    showCard: function () {this.show = true},
    getDay: function (checkIn) { return checkIn.getDate() },
    getMonth: function (checkIn) { return checkIn.getMonth() + 1 },
    getYear: function (checkIn) { return checkIn.getFullYear() },
    getUrl: function (day, month, year, nights, hotelId, affiliateid, server) {
      return server + '?u=%3Faid%3D' + affiliateid + '%26rtype%3D7%26hids%3D' + hotelId + '%26sdate%3D' + year + '-' + month + '-' + day + '%26nights%3D' + nights
    },
    getLink: function (url, day, month, year, nights, hotelId, affiliateid) {
      if (('' + day).length === 1) day = '0' + day
      if (('' + month).length === 1) month = '0' + month
      return url + '' + affiliateid +
      '/hotel-reservations/' + hotelId + '.aspx?d=' + year + month + day +
      '&n=' + nights + '&rt=2-0&adult=2&child=0'
      // working link http://www.laterooms.com/en/p3095/hotel-reservations/73022.aspx?d=20151201&n=4&rt=2-0&adult=2&child=0
    },
    getRate: function (rates) {
      rates = rates.filter(isBigEnough)
      if (rates.length > 0 && rates.sort()[rates.length - 1] > 1) {
        return 'Â£' + rates.sort()[rates.length - 1].toFixed(2)
      } else {
        return 'No rates available'
      }
    }
  })
  function isBigEnough(value) {
    return +value > 1;
  }

</script>
